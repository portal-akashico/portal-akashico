<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Tu Lectura ✨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        background: #050512;
        color: #ffffff;
        padding: 20px;
      }

      .container {
        max-width: 700px;
        margin: 0 auto;
        background: #11111f;
        border-radius: 18px;
        padding: 26px 26px 36px;
        box-shadow:
          0 0 40px rgba(125, 66, 255, 0.85),
          0 0 80px rgba(125, 66, 255, 0.55);
        position: relative;
      }

      .container::before {
        content: "";
        position: absolute;
        inset: -3px;
        border-radius: 20px;
        background: radial-gradient(
          circle at top,
          rgba(197, 139, 255, 0.35),
          transparent 65%
        );
        z-index: -1;
      }

      h1 {
        text-align: center;
        font-size: 26px;
        margin-bottom: 10px;
        background: linear-gradient(90deg, #ffce73, #d38bff);
        -webkit-background-clip: text;
        color: transparent;
      }

      h2 {
        text-align: center;
        color: #e9d6ff;
        margin-top: 0;
        font-size: 16px;
        margin-bottom: 20px;
      }

      #lectura-texto {
        white-space: pre-line;
        line-height: 1.65;
        font-size: 15px;
        color: #f4ecff;
        opacity: 0;
        transition: opacity 0.5s ease;
      }

      .download-container {
        margin-top: 25px;
        text-align: right;
        display: none;
      }

      .download-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        background: linear-gradient(90deg, #c88bff, #ffb86c);
        color: #0b0318;
        box-shadow: 0 0 18px rgba(200, 139, 255, 0.55);
        transition: 0.15s ease;
      }

      .download-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 26px rgba(200, 139, 255, 0.7);
      }

      .download-icon {
        width: 20px;
        height: 20px;
      }

      .section-box {
        max-width: 700px;
        margin: 22px auto 0;
        background: #11111f;
        border-radius: 16px;
        padding: 20px 24px;
        box-shadow: 0 0 22px rgba(109, 52, 255, 0.4);
        text-align: center;
      }

      #btn-volver {
        width: 100%;
        padding: 12px;
        font-size: 15px;
        border-radius: 8px;
        background: #1f1f35;
        color: #f3cfff;
        border: 1px solid #3f3f70;
        cursor: pointer;
      }

      #btn-volver:hover {
        opacity: 0.9;
      }

      /* --- LOADER / ESTADO DE CARGA --- */
      .loader-wrapper {
        margin-top: 10px;
        padding: 18px 16px 6px;
        border-radius: 14px;
        background: radial-gradient(
          circle at top,
          rgba(200, 139, 255, 0.08),
          rgba(10, 5, 30, 0.9)
        );
        border: 1px solid rgba(158, 116, 255, 0.6);
      }

      .loader-row {
        display: flex;
        align-items: center;
        gap: 10px;
        justify-content: center;
        margin-bottom: 8px;
      }

      .loader-circle {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.4);
        border-top-color: #ffce73;
        animation: spin 0.75s linear infinite;
      }

      .loader-text {
        font-size: 14px;
        color: #e7d4ff;
      }

      .loader-subtext {
        font-size: 12px;
        color: #b7a5ff;
        text-align: center;
        margin-bottom: 6px;
      }

      .loader-bar {
        width: 100%;
        height: 5px;
        border-radius: 999px;
        background: rgba(80, 60, 140, 0.5);
        overflow: hidden;
      }

      .loader-bar-inner {
        width: 35%;
        height: 100%;
        border-radius: 999px;
        background: linear-gradient(90deg, #ffce73, #d38bff);
        animation: slide 1.1s ease-in-out infinite;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      @keyframes slide {
        0% {
          transform: translateX(-120%);
        }
        50% {
          transform: translateX(20%);
        }
        100% {
          transform: translateX(120%);
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1 id="titulo-principal">✨ Canalizando tu lectura ✨</h1>
      <h2 id="subtitulo-lectura">
        Hemos recibido tu pago. Estoy abriendo tus Registros…
      </h2>

      <!-- BLOQUE DE CARGA VISUAL -->
      <div id="loading-state" class="loader-wrapper">
        <div class="loader-row">
          <div class="loader-circle"></div>
          <p class="loader-text">
            Canalizando tu lectura… esto puede tardar algunos instantes.
          </p>
        </div>
        <p class="loader-subtext">
          Por favor no cierres esta ventana. Tu lectura se generará y se enviará
          a tu correo automáticamente.
        </p>
        <div class="loader-bar">
          <div class="loader-bar-inner"></div>
        </div>
      </div>

      <div id="lectura-texto">
        <!-- Aquí aparecerá la lectura cuando esté lista -->
      </div>

      <div class="download-container" id="download-wrapper">
        <button class="download-btn" id="btn-descargar-lectura">
          <svg viewBox="0 0 24 24" class="download-icon">
            <path
              d="M12 3v11m0 0l-4-4m4 4l4-4M5 19h14v2H5z"
              stroke="currentColor"
              stroke-width="2"
              fill="none"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          Descargar lectura en PDF
        </button>
      </div>
    </div>

    <div class="section-box">
      <button id="btn-volver" onclick="volverAlPortal()">
        ⬅ Volver al Portal Akáshico
      </button>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        const sessionId = params.get("session_id");

        if (!sessionId) {
          alert(
            "No se encontró la sesión de pago. Si ya realizaste el pago, por favor vuelve al portal."
          );
          window.location.href = "/";
          return;
        }

        iniciarProcesoLectura(sessionId);
      });

      async function iniciarProcesoLectura(sessionId) {
        try {
          const resp = await fetch("/api/finalizar-lectura", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ session_id: sessionId }),
          });

          const data = await resp.json();

          if (!resp.ok) {
            alert(data.error || "No se pudo finalizar la lectura.");
            window.location.href = "/";
            return;
          }

          // Guardamos en localStorage
          localStorage.setItem("lecturaActual", JSON.stringify(data));

          // Títulos según tipo
          const TITULOS = {
            akashica: {
              principal: "✨ Tu Lectura Akáshica ✨",
              subtitulo: "Lectura Akáshica — Canalizada",
            },
            vidas: {
              principal: "✨ Tu Lectura de Vidas Pasadas ✨",
              subtitulo: "Memorias del Alma — Canalizadas",
            },
            futuro: {
              principal: "✨ Tu Lectura de Camino Futuro ✨",
              subtitulo: "Potenciales y Caminos — Canalizados",
            },
            alma: {
              principal: "✨ Tu Lectura de Alma Gemela ✨",
              subtitulo: "Vínculos del Alma — Canalizados",
            },
          };

          const tipo = data.tipoLectura || "akashica";
          const cfg = TITULOS[tipo] || TITULOS.akashica;

          document.getElementById("titulo-principal").innerText =
            cfg.principal;
          document.getElementById("subtitulo-lectura").innerText =
            cfg.subtitulo;
          document.getElementById("lectura-texto").innerText =
            data.lectura || "";

          // Ocultamos el loader y mostramos lectura + botón PDF
          const loading = document.getElementById("loading-state");
          if (loading) loading.style.display = "none";

          const lecturaTexto = document.getElementById("lectura-texto");
          lecturaTexto.style.opacity = "1";

          const downloadWrapper =
            document.getElementById("download-wrapper");
          downloadWrapper.style.display = "block";

          document
            .getElementById("btn-descargar-lectura")
            .addEventListener("click", descargarPDF);
        } catch (err) {
          console.error(err);
          alert(
            "Ocurrió un error al canalizar tu lectura. Si ya se cobró el pago, por favor escríbeme por correo."
          );
          window.location.href = "/";
        }
      }

      function descargarPDF() {
        const { jsPDF } = window.jspdf;

        const dataRaw = localStorage.getItem("lecturaActual") || "{}";
        let data = {};
        try {
          data = JSON.parse(dataRaw);
        } catch (e) {
          console.error(e);
        }

        const tipoLectura = data.tipoLectura || "akashica";
        const texto =
          document.getElementById("lectura-texto")?.innerText || "";
        const subtitulo =
          document.getElementById("subtitulo-lectura")?.innerText ||
          "Lectura canalizada";

        const TITULOS_PDF = {
          akashica: "Tu Lectura Akashica",
          vidas: "Tu Lectura de Vidas Pasadas",
          futuro: "Tu Lectura de Camino Futuro",
          alma: "Tu Lectura de Alma Gemela & Vinculos del Alma",
        };
        const tituloPDF =
          TITULOS_PDF[tipoLectura] || TITULOS_PDF.akashica;

        const pdf = new jsPDF({
          unit: "pt",
          format: "letter",
        });

        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();

        pdf.setFillColor(5, 5, 18);
        pdf.rect(0, 0, pageWidth, pageHeight, "F");

        pdf.setDrawColor(109, 52, 255);
        pdf.setLineWidth(1.2);
        pdf.roundedRect(24, 24, pageWidth - 48, pageHeight - 48, 12, 12);

        pdf.setFont("Times", "Bold");
        pdf.setFontSize(20);
        pdf.setTextColor(233, 197, 255);
        pdf.text(tituloPDF, pageWidth / 2, 60, { align: "center" });

        pdf.setFont("Times", "Normal");
        pdf.setFontSize(14);
        pdf.setTextColor(243, 207, 255);
        pdf.text(subtitulo, pageWidth / 2, 84, { align: "center" });

        pdf.setDrawColor(120, 80, 255);
        pdf.setLineWidth(0.6);
        pdf.line(72, 100, pageWidth - 72, 100);

        pdf.setFont("Times", "Normal");
        pdf.setFontSize(12);
        pdf.setTextColor(230, 225, 255);

        const marginX = 60;
        const usableWidth = pageWidth - marginX * 2;
        const lineHeight = 18;
        let y = 120;

        const parrafos = texto.split(/\n{2,}/);

        function nuevaPagina() {
          pdf.addPage();
          pdf.setFillColor(5, 5, 18);
          pdf.rect(0, 0, pageWidth, pageHeight, "F");
          pdf.setDrawColor(109, 52, 255);
          pdf.setLineWidth(1.2);
          pdf.roundedRect(24, 24, pageWidth - 48, pageHeight - 48, 12, 12);

          pdf.setFont("Times", "Normal");
          pdf.setFontSize(12);
          pdf.setTextColor(230, 225, 255);
          y = 60;
        }

        parrafos.forEach((p) => {
          const lineas = pdf.splitTextToSize(p.trim(), usableWidth);

          lineas.forEach((linea) => {
            if (y > pageHeight - 72) nuevaPagina();
            pdf.text(linea, marginX, y);
            y += lineHeight;
          });

          y += lineHeight;
        });

        pdf.save(`Lectura_${tipoLectura}_${Date.now()}.pdf`);
      }

      function volverAlPortal() {
        window.location.href = "/";
      }
    </script>
  </body>
</html>
